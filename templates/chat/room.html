{% extends 'base.html' %}
{% load static %}

{% block title %} Conversation with the nurse{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">

<div class="card chat-card">
    
    <div class="chat-header">
        <div>
            <strong>Conversation with the nurse</strong>
            <span class="status-dot">â— connected</span>
        </div>
        
        <form action="{% url 'logout' %}" method="post" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" style="background: none; border: 1px solid #dc3545; color: #dc3545; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">
                Logout
            </button>
        </form>
    </div>

    <div id="chat-log">
        {% for message in chat_messages %}
            <div id="msg-{{ message.id }}" class="message {% if message.sender == user %}sent{% else %}received{% endif %}">

                {% if message.sender != user %}
                    <span class="sender-label">Nurse ğŸ‘©â€âš•ï¸</span>
                {% endif %}
                
                {% if message.image %}
                    <a href="{{ message.image.url }}" target="_blank">
                        <img src="{{ message.image.url }}?v={{ message.timestamp|date:'U' }}" class="chat-image">
                    </a>
                {% else %}
                    <!-- ğŸ›‘ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¶: Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ù†ØµØ§Ù‹ Ø¹Ø§Ø¯ÙŠØ§Ù‹ Ø£Ùˆ Ù…ÙØ±ØºØ§Ù‹ Ù…Ù† ØµÙˆØª -->
                    <div class="msg-body">
                        {% if message.sender == user %}
                            {{ message.text_original }}
                        {% else %}
                            {{ message.text_translated|default:message.text_original }}
                        {% endif %}
                    </div>
                {% endif %}

                <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙˆÙ‚Øª ÙˆØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØµØ­ -->
                <div class="meta-info">
                    <span class="time">{{ message.timestamp|date:"Y-m-d / H:i" }}</span>
                    
                    {% if message.sender == user %}
                        <span class="tick-container tick-status">
                            {% if message.is_read %}
                                <span style="color: #69f0ae;">âœ”âœ”</span> 
                            {% else %}
                                <span style="color: #ccc;">âœ”</span> 
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <div id="error-banner" style="display: none; background-color: #ffebee; color: #c62828; padding: 10px; text-align: center; border-top: 1px solid #ef9a9a; font-size: 0.9em; font-weight: bold;"></div>

    <div class="chat-input-area" style="flex-direction: column; gap: 0;">
        <div style="display: flex; width: 100%; gap: 10px; margin-bottom: 5px;">
            <input type="file" id="image-input" accept="image/*" style="display: none;">
            <button id="image-btn" title="Send image">ğŸ“</button>
            
            <!-- ğŸ›‘ Ø²Ø± Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ† -->
            <button id="mic-btn" class="mic-button" title="Hold to Record">ğŸ¤</button>

            <input id="chat-message-input" type="text" placeholder="Write your message here..." style="flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc;">
            <button id="chat-message-submit" class="btn-primary" style="margin: 0; padding: 0 20px; border-radius: 20px;">â¤</button>
        </div>

        <div style="text-align: center; font-size: 0.75rem; color: #eb6d07; padding-bottom: 5px;">
            {{ privacy_warning }}
        </div>
    </div>
</div>

<script src="{% static 'js/chat.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initChat({
            sessionId: "{{ session.id }}",
            userId: "{{ user.id }}", 
            csrfToken: "{{ csrf_token }}",
            uploadUrl: "{% url 'chat_upload_image' %}"
        });
    });
</script>
{% endblock %}