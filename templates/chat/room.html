{% extends 'base.html' %}
{% load static %}

{% block title %} Conversation with the nurse{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">

<div class="card chat-card">
    
    <div class="chat-header">
        <div>
            <strong>Conversation with the nurse</strong>
            <span class="status-dot">â— connected</span>
        </div>
         <div style="display: flex; gap: 10px; align-items: center;">
            <form action="{% url 'delete_account' %}" method="post" onsubmit="return confirm('âš ï¸ Are you sure you want to delete your account permanently?\n\nThis action cannot be undone and all your medical history will be lost.');" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn-delete-account" title="Delete my account">
                    ğŸ—‘ï¸ Delete Account
                </button>
            </form>




        <form action="{% url 'logout' %}" method="post" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" style="background: none; border: 1px solid #dc3545; color: #dc3545; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">
                Logout
            </button>
        </form>

        </div>
    </div>




    <div id="chat-log">
        {% for message in chat_messages %}
            <div id="msg-{{ message.id }}" class="message {% if message.sender == user %}sent{% else %}received{% endif %}">

                {% if message.sender != user %}
                    <span class="sender-label">Nurse ğŸ‘©â€âš•ï¸</span>
                {% endif %}
                
                {% if message.image %}
                    <a href="{{ message.image.url }}" target="_blank">
                        <img src="{{ message.image.url }}?v={{ message.timestamp|date:'U' }}" class="chat-image">
                    </a>
                {% else %}
                    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ -->
                    <div class="msg-body">
                        {% if message.sender == user %}
                            {{ message.text_original }}
                        {% else %}
                            {{ message.text_translated|default:message.text_original }}
                        {% endif %}
                    </div>
                {% endif %}

                <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙˆÙ‚Øª ÙˆØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØµØ­ -->
                <div class="meta-info">
                    <span class="time">{{ message.timestamp|date:"Y-m-d / H:i" }}</span>
                    
                    {% if message.sender == user %}
                        <span class="tick-container tick-status">
                            {% if message.is_read %}
                                <span style="color: #69f0ae;">âœ”âœ”</span> 
                            {% else %}
                                <span style="color: #ccc;">âœ”</span> 
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <div id="error-banner" style="display: none; background-color: #ffebee; color: #c62828; padding: 10px; text-align: center; border-top: 1px solid #ef9a9a; font-size: 0.9em; font-weight: bold;"></div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© -->
    <div class="chat-input-area">
        
        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ù†Øµ ÙˆØ²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
        <div class="input-main-row">
            <input id="chat-message-input" type="text" placeholder="Write your message here..." autocomplete="off">
            <button id="chat-message-submit" class="btn-primary">â¤</button>
        </div>

        <!-- Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø£Ø¯ÙˆØ§Øª (ØµÙˆØ± ÙˆØµÙˆØª) -->
        <div class="input-tools-row">
            <input type="file" id="image-input" accept="image/*" style="display: none;">
            
            <button id="image-btn" title="Send image">ğŸ“</button>
            <button id="mic-btn" class="mic-button" title="Hold to Record">ğŸ¤</button>
            
            <!-- Ù…Ø³Ø§Ø­Ø© ÙØ§Ø±ØºØ© Ø£Ùˆ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
            <div class="privacy-text">
                {{ privacy_warning }}
            </div>
        </div>

    </div>

     <!-- ğŸ›‘ ÙƒÙˆØ¯ Ø§Ù„Ù€ Overlay Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø£Ø¶ÙÙ‡ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù) -->
    <div id="recording-overlay" class="recording-overlay">
        <div class="recording-content">
            <div class="mic-large-icon">ğŸ™ï¸</div> <!-- Ø£Ùˆ ğŸ¤ -->
            <p class="recording-hint">Recording... Release to send</p>
        </div>
    </div>
</div>

<script src="{% static 'js/chat.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        initChat({
            sessionId: "{{ session.id }}",
            userId: "{{ user.id }}", 
            csrfToken: "{{ csrf_token }}",
            uploadUrl: "{% url 'chat_upload_image' %}"
        });
    });
</script>
{% endblock %}